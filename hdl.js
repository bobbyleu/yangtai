/**
 * cron: 40 5 * * *
 *
 * 海底捞
 * 抓https://superapp-public.kiwa-tech.com/api/gateway/login/center/login/wechatLogin 把unionId、openId填到变量里 多个换行:
 * export hdl_ck="openId#unionId"
 */
function _0x15bd(){const _0x243055=['1263078aOzYIt','42vvijql','2773412WtfUsP','46884871wGOWvi','1110cqUAZY','15xFORRK','14902kcZasJ','402642XRfQNt','35361FsUrnQ','20657XjdYgu','4256HHTVDM'];_0x15bd=function(){return _0x243055;};return _0x15bd();}(function(_0x5712f6,_0x2ab92c){const _0x1f038c={_0x1b6fb4:0x136,_0x2c08fc:0x131,_0x3f93cd:0x137,_0x4ae175:0x12e,_0x2383d5:0x134,_0x42b7bd:0x133},_0xf8ea80=_0x408b,_0x2ab868=_0x5712f6();while(!![]){try{const _0x19b175=-parseInt(_0xf8ea80(0x130))/0x1+-parseInt(_0xf8ea80(_0x1f038c._0x1b6fb4))/0x2*(parseInt(_0xf8ea80(_0x1f038c._0x2c08fc))/0x3)+-parseInt(_0xf8ea80(0x132))/0x4+parseInt(_0xf8ea80(0x135))/0x5*(-parseInt(_0xf8ea80(_0x1f038c._0x3f93cd))/0x6)+-parseInt(_0xf8ea80(_0x1f038c._0x4ae175))/0x7*(parseInt(_0xf8ea80(0x12f))/0x8)+parseInt(_0xf8ea80(0x138))/0x9*(parseInt(_0xf8ea80(_0x1f038c._0x2383d5))/0xa)+parseInt(_0xf8ea80(_0x1f038c._0x42b7bd))/0xb;if(_0x19b175===_0x2ab92c)break;else _0x2ab868['push'](_0x2ab868['shift']());}catch(_0x304a83){_0x2ab868['push'](_0x2ab868['shift']());}}}(_0x15bd,0xd384e));function _0x408b(_0x527f47,_0x3d1422){const _0x15bd05=_0x15bd();return _0x408b=function(_0x408ba2,_0x395fce){_0x408ba2=_0x408ba2-0x12e;let _0x10fc04=_0x15bd05[_0x408ba2];return _0x10fc04;},_0x408b(_0x527f47,_0x3d1422);}const $=new Env('海底捞');const axios=require('axios');const {sendNotify}=require('./sendNotify');let notifyStr='';(async()=>{const hdl_ck=process.env.hdl_ck;if(!hdl_ck){logAndNotify('请设置 hdl_ck');return;}let ckList=hdl_ck.split('\n');for(let i=0;i<ckList.length;i++){let oid=ckList[i].split('#')[0];let uid=ckList[i].split('#')[1];const loginResponse=await sendPostRequest('https://superapp-public.kiwa-tech.com/api/gateway/login/center/login/wechatLogin',undefined,{'type':1,'country':'CN','codeType':1,'business':'登录','terminal':'会员小程序','openId':`${oid}`,'uid':`${uid}`});if(loginResponse.data.code!==100000){logAndNotify(`账号【${i+1}】已失效`);continue;}logAndNotify(`账号【${i+1}】【${loginResponse.data.data.mobile}】 登录成功`);const tokenData=loginResponse.data.data;const signinInfoResponse=await sendPostRequest('https://superapp-public.kiwa-tech.com/activity/wxapp/signin/query',tokenData.token,{});logAndNotify(`账号【${i+1}】活动名称【${signinInfoResponse.data.data.activityName}】`);if(signinInfoResponse.data.data.signinOr===0){const signinResponse=await sendPostRequest('https://superapp-public.kiwa-tech.com/activity/wxapp/signin/signin',tokenData.token,{'signinSource':'MiniApp'});if(signinResponse.data.code==='ok'){const signinList=signinResponse.data.data.signinQueryDetailList;if(signinList.length===0){logAndNotify(`账号【${i+1}】签到失败 signinList.length === 0`);continue;}const data=signinList[0];logAndNotify(`账号【${i+1}】签到成功 碎片+【${data.fragment}】 额外奖励+【${data.fragmentSeries}】 菜品【${data.dishes}】`);}}else{logAndNotify(`账号【${i+1}】已签到过了`);}const queryFragmentResponse=await sendPostRequest('https://superapp-public.kiwa-tech.com/activity/wxapp/signin/queryFragment',tokenData.token,{});logAndNotify(`账号【${i+1}】碎片【${queryFragmentResponse.data.data.total}】 活动结束时间【${queryFragmentResponse.data.data.expireDate}】`);}})().catch(e=>{logAndNotify(e);}).finally(()=>{sendNotify('海底捞',notifyStr);$.done();});function logAndNotify(str){$.log(str);notifyStr+=str;notifyStr+='\n';}var headersTemp={'content-type':'application/json','appId':15,'appVersion':'3.79.0','Accept-Encoding':'gzip,compress,br,deflate','User-Agent':'Mozilla/5.0 (iPhone; CPU iPhone OS 17_1_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.49(0x18003130) NetType/WIFI Language/zh_CN','Referer':'https://servicewechat.com/wx1ddeb67115f30d1a/138/page-frame.html'};function sendPostRequest(url,token,postData){let headers={};if(token){headers={...headersTemp,...{'_HAIDILAO_APP_TOKEN':`${token}`}};}else{headers=headersTemp;}const apiClient=axios.create({headers:headers});return apiClient.post(url,postData);}function Env(t,e){'undefined'!=typeof process&&JSON.stringify(process.env).indexOf('GITHUB')>-1&&process.exit(0);class s{constructor(t){this.env=t;}send(t,e='GET'){t='string'==typeof t?{url:t}:t;let s=this.get;return'POST'===e&&(s=this.post),new Promise((e,i)=>{s.call(this,t,(t,s,r)=>{t?i(t):e(s);});});}get(t){return this.send.call(this.env,t);}post(t){return this.send.call(this.env,t,'POST');}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile='box.dat',this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator='\n',this.startTime=new Date().getTime(),Object.assign(this,e),this.log('',`🔔${this.name}, 开始!`);}isNode(){return'undefined'!=typeof module&&!!module.exports;}isQuanX(){return'undefined'!=typeof $task;}isSurge(){return'undefined'!=typeof $httpClient&&'undefined'==typeof $loon;}isLoon(){return'undefined'!=typeof $loon;}toObj(t,e=null){try{return JSON.parse(t);}catch{return e;}}toStr(t,e=null){try{return JSON.stringify(t);}catch{return e;}}getjson(t,e){let s=e;const i=this.getdata(t);if(i)try{s=JSON.parse(this.getdata(t));}catch{}return s;}setjson(t,e){try{return this.setdata(JSON.stringify(t),e);}catch{return!1;}}getScript(t){return new Promise(e=>{this.get({url:t},(t,s,i)=>e(i));});}runScript(t,e){return new Promise(s=>{let i=this.getdata('@chavy_boxjs_userCfgs.httpapi');i=i?i.replace(/\n/g,'').trim():i;let r=this.getdata('@chavy_boxjs_userCfgs.httpapi_timeout');r=r?1*r:20,r=e&&e.timeout?e.timeout:r;const [o,h]=i.split('@'),n={url:`http://${h}/v1/scripting/evaluate`,body:{script_text:t,mock_type:'cron',timeout:r},headers:{'X-Key':o,Accept:'*/*'}};this.post(n,(t,e,i)=>s(i));}).catch(t=>this.logErr(t));}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require('fs'),this.path=this.path?this.path:require('path');const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};{const i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i));}catch(t){return{};}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require('fs'),this.path=this.path?this.path:require('path');const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e),r=JSON.stringify(this.data);s?this.fs.writeFileSync(t,r):i?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r);}}lodash_get(t,e,s){const i=e.replace(/\[(\d+)\]/g,'.$1').split('.');let r=t;for(const t of i)if(r=Object(r)[t],void 0===r)return s;return r;}lodash_set(t,e,s){return Object(t)!==t?t:(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce((t,s,i)=>Object(t[s])===t[s]?t[s]:t[s]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{},t)[e[e.length-1]]=s,t);}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const [,s,i]=/^@(.*?)\.(.*?)$/.exec(t),r=s?this.getval(s):'';if(r)try{const t=JSON.parse(r);e=t?this.lodash_get(t,i,''):e;}catch(t){e='';}}return e;}setdata(t,e){let s=!1;if(/^@/.test(e)){const [,i,r]=/^@(.*?)\.(.*?)$/.exec(e),o=this.getval(i),h=i?'null'===o?null:o||'{}':'{}';try{const e=JSON.parse(h);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),i);}catch(e){const o={};this.lodash_set(o,r,t),s=this.setval(JSON.stringify(o),i);}}else s=this.setval(t,e);return s;}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null;}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null;}initGotEnv(t){this.got=this.got?this.got:require('got'),this.cktough=this.cktough?this.cktough:require('tough-cookie'),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar(),t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar));}get(t,e=()=>{}){t.headers&&(delete t.headers['Content-Type'],delete t.headers['Content-Length']),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{'X-Surge-Skip-Scripting':!1})),$httpClient.get(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i);})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const {statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o);},t=>e(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on('redirect',(t,e)=>{try{if(t.headers['set-cookie']){const s=t.headers['set-cookie'].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar;}}catch(t){this.logErr(t);}}).then(t=>{const {statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o);},t=>{const {message:s,response:i}=t;e(s,i,i&&i.body);}));}post(t,e=()=>{}){if(t.body&&t.headers&&!t.headers['Content-Type']&&(t.headers['Content-Type']='application/x-www-form-urlencoded'),t.headers&&delete t.headers['Content-Length'],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{'X-Surge-Skip-Scripting':!1})),$httpClient.post(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i);});else if(this.isQuanX())t.method='POST',this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const {statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o);},t=>e(t));else if(this.isNode()){this.initGotEnv(t);const {url:s,...i}=t;this.got.post(s,i).then(t=>{const {statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o);},t=>{const {message:s,response:i}=t;e(s,i,i&&i.body);});}}time(t,e=null){const s=e?new Date(e):new Date();let i={'M+':s.getMonth()+1,'d+':s.getDate(),'H+':s.getHours(),'m+':s.getMinutes(),'s+':s.getSeconds(),'q+':Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(s.getFullYear()+'').substr(4-RegExp.$1.length)));for(let e in i)new RegExp('('+e+')').test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[e]:('00'+i[e]).substr((''+i[e]).length)));return t;}msg(e=t,s='',i='',r){const o=t=>{if(!t)return t;if('string'==typeof t)return this.isLoon()?t:this.isQuanX()?{'open-url':t}:this.isSurge()?{url:t}:void 0;if('object'==typeof t){if(this.isLoon()){let e=t.openUrl||t.url||t['open-url'],s=t.mediaUrl||t['media-url'];return{openUrl:e,mediaUrl:s};}if(this.isQuanX()){let e=t['open-url']||t.url||t.openUrl,s=t['media-url']||t.mediaUrl;return{'open-url':e,'media-url':s};}if(this.isSurge()){let e=t.url||t.openUrl||t['open-url'];return{url:e};}}};if(this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,s,i,o(r)):this.isQuanX()&&$notify(e,s,i,o(r))),!this.isMuteLog){let t=['','==============\uD83D\uDCE3系统通知\uD83D\uDCE3=============='];t.push(e),s&&t.push(s),i&&t.push(i),console.log(t.join('\n')),this.logs=this.logs.concat(t);}}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator));}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log('',`❗️${this.name}, 错误!`,t.stack):this.log('',`❗️${this.name}, 错误!`,t);}wait(t){return new Promise(e=>setTimeout(e,t));}done(t={}){const e=new Date().getTime(),s=(e-this.startTime)/1000;this.log('',`🔔${this.name}, 结束! 🕛 ${s} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t);}}(t,e);}